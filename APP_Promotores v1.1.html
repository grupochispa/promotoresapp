<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Captura de Precios</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="App para capturar precios de productos y competidores">
    
    <link rel="manifest" href="/manifest.json">
    
    <link rel="apple-touch-icon" href="pwa_icons/apple-icon-180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="pwa_icons/android-icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="pwa_icons/android-icon-512.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/dist/umd/supabase.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            overscroll-behavior: none;
            background: linear-gradient(to bottom, #EEF2FF, #E5E7EB);
        }
        @media (max-width: 640px) {
            .container { padding: 0.5rem; }
            button, select, input { font-size: 1rem; min-height: 48px; }
            .btn-icon { width: 48px; height: 48px; }
        }
        button, select, input {
            transition: all 0.2s ease-in-out;
        }
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .card {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border-radius: 1rem;
        }
        .input-focus:focus {
            outline: none;
            box-shadow: 0 0 8px rgba(79, 70, 229, 0.3);
            border-color: #4F46E5;
        }
        .btn-primary {
            background: linear-gradient(to right, #4F46E5, #7C3AED);
        }
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(to right, #4338CA, #6D28D9);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Error Boundary
        class ErrorBoundary extends React.Component {
            state = { error: null };
            static getDerivedStateFromError(error) {
                return { error: error.message };
            }
            render() {
                if (this.state.error) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-gradient-to-b from-indigo-100 to-gray-100 p-4">
                            <div className="w-full max-w-md bg-white card p-6">
                                <h2 className="text-xl font-bold text-red-600 mb-4">Error</h2>
                                <p className="text-gray-600 text-sm">{this.state.error}</p>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // Configuraci√≥n Supabase
        const supabaseUrl = 'https://zgbsrbjtjnozpzxifpua.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnYnNyYmp0am5venB6eGlmcHVhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNjI5MjUsImV4cCI6MjA2OTkzODkyNX0.zHVKe6Ab73PFhQqD3Au94x1Z71hMyRpxE1PCWP8-QTI';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Componente: Top 5 Promotores del D√≠a
        const TopSellers = () => {
            const [topSellers, setTopSellers] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchTopSellers = async () => {
                    setLoading(true);
                    try {
                        const now = new Date();
                        now.setHours(0, 0, 0, 0);

                        const { data, error } = await supabase
                            .from('web_precios')
                            .select('promoter_name')
                            .gte('created_at', now.toISOString());

                        if (error) throw error;

                        const counts = data.reduce((acc, item) => {
                            acc[item.promoter_name] = (acc[item.promoter_name] || 0) + 1;
                            return acc;
                        }, {});

                        const sorted = Object.entries(counts)
                            .map(([name, count]) => ({ name, count }))
                            .sort((a, b) => b.count - a.count)
                            .slice(0, 5);

                        setTopSellers(sorted);
                    } catch (e) {
                        console.error('Error al cargar top:', e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchTopSellers();
            }, []);

            return (
                <div className="bg-white card p-5 mb-6 shadow-md">
                    <h3 className="text-lg font-bold text-indigo-700 mb-4 text-center">üèÜ Top 5 Promotores del D√≠a</h3>
                    {loading ? (
                        <p className="text-gray-500 text-sm text-center">Cargando ranking...</p>
                    ) : topSellers.length > 0 ? (
                        <ol className="space-y-3">
                            {topSellers.map((seller, index) => {
                                const medal = index === 0 ? "ü•á" : index === 1 ? "ü•à" : index === 2 ? "ü•â" : `#${index + 1}`;
                                return (
                                    <li key={seller.name} className="flex justify-between items-center px-4 py-2 bg-gray-50 rounded-lg">
                                        <div className="flex items-center gap-3">
                                            <span className="font-bold text-lg">{medal}</span>
                                            <span className="font-medium">{seller.name}</span>
                                        </div>
                                        <span className="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold">
                                            {seller.count} visita(s)
                                        </span>
                                    </li>
                                );
                            })}
                        </ol>
                    ) : (
                        <p className="text-gray-500 text-sm text-center">No hay datos hoy.</p>
                    )}
                </div>
            );
        };

        // Pantalla de Login con Top 5
        const LoginScreen = ({ onLogin }) => {
            const [promoterId, setPromoterId] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);

                try {
                    const { data, error } = await supabase
                        .from('web_promotores')
                        .select('promoter_name, estado_id')
                        .eq('promoter_id', promoterId)
                        .single();

                    if (error) {
                        setError('ID de promotor no encontrado.');
                    } else {
                        let estadoNombre = '', zonaNombre = promoterId.replace('promotor_', '').replace(/_/g, '-');
                        if (data.estado_id) {
                            const { data: estadoData } = await supabase
                                .from('web_estados')
                                .select('nombre')
                                .eq('id', data.estado_id)
                                .single();
                            estadoNombre = estadoData?.nombre || '';

                            const { data: zonaData } = await supabase
                                .from('web_zonas')
                                .select('nombre')
                                .eq('nombre', `Zona ${zonaNombre}`)
                                .eq('estado_id', data.estado_id)
                                .single();
                            zonaNombre = zonaData?.nombre.replace('Zona ', '') || '';
                        }
                        onLogin(promoterId, data.promoter_name, estadoNombre, zonaNombre);
                    }
                } catch (e) {
                    setError('Error al iniciar sesi√≥n.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-indigo-100 to-gray-100 p-4">
                    <div className="w-full max-w-md bg-white card p-6">
                        <TopSellers />

                        <h1 className="text-2xl font-extrabold text-center text-indigo-700 mb-4">Ingresa tu ID</h1>
                        <p className="text-center text-gray-600 mb-6 text-sm">Ingresa tu ID de promotor para continuar.</p>
                        <form onSubmit={handleLogin} className="flex flex-col gap-4">
                            <input type="text" placeholder="ID de promotor" value={promoterId}
                                   onChange={(e) => setPromoterId(e.target.value)}
                                   className="w-full p-3 border border-gray-300 rounded-xl input-focus" required />
                            <button type="submit" disabled={loading}
                                    className="w-full btn-primary text-white font-semibold py-3 rounded-xl shadow-md flex items-center justify-center gap-2 disabled:bg-indigo-300">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                                    <polyline points="10 17 15 12 10 7"/>
                                    <line x1="15" x2="3" y1="12" y2="12"/>
                                </svg>
                                {loading ? 'Cargando...' : 'Ingresar'}
                            </button>
                        </form>
                        {error && (
                            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mt-4 rounded-lg text-sm">
                                {error}
                            </div>
                        )}
                        <div className="text-center text-gray-500 text-xs mt-6">Versi√≥n 1.1</div>
                    </div>
                </div>
            );
        };

        const Icon = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
                 className={`lucide ${className}`}>
                {children}
            </svg>
        );

        const Plus = ({ size }) => (
            <Icon size={size}>
                <path d="M5 12h14" />
                <path d="M12 5v14" />
            </Icon>
        );

        const Minus = ({ size }) => (
            <Icon size={size}>
                <path d="M5 12h14" />
            </Icon>
        );

        const Save = ({ size }) => (
            <Icon size={size}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                <polyline points="17 21 17 13 7 13 7 21" />
                <polyline points="7 3 7 8 15 8" />
            </Icon>
        );

        const ItemRow = ({ item, type, onChange, onRemove, presentations, currencies, canRemove }) => (
            <div className="flex flex-col sm:flex-row gap-2 mb-2 p-2 bg-gray-50 rounded-lg card">
                <select value={item.presentation} onChange={(e) => onChange(e, type, item.id, 'presentation')}
                        className="w-full sm:w-1/2 p-3 border border-gray-300 rounded-xl input-focus" required>
                    <option value="">-- Presentaci√≥n --</option>
                    {presentations.map(p => <option key={p} value={p}>{p}</option>)}
                </select>
                <input type="number" placeholder="Precio" value={item.price}
                       onChange={(e) => onChange(e, type, item.id, 'price')}
                       className="w-full sm:w-1/4 p-3 border border-gray-300 rounded-xl input-focus" required />
                <select value={item.currency} onChange={(e) => onChange(e, type, item.id, 'currency')}
                        className="w-full sm:w-1/4 p-3 border border-gray-300 rounded-xl input-focus" required>
                    <option value="">-- Moneda --</option>
                    {currencies.map(c => <option key={c} value={c}>{c}</option>)}
                </select>
                {type === 'myitems' && (
                    <>
                        <input type="number" placeholder="Stock Anaquel" value={item.stock_shelf}
                               onChange={(e) => onChange(e, type, item.id, 'stock_shelf')}
                               className="w-full sm:w-1/6 p-3 border border-gray-300 rounded-xl input-focus" required />
                        <input type="number" placeholder="Stock Bodega" value={item.stock_warehouse}
                               onChange={(e) => onChange(e, type, item.id, 'stock_warehouse')}
                               className="w-full sm:w-1/6 p-3 border border-gray-300 rounded-xl input-focus" required />
                    </>
                )}
                {canRemove && (
                    <button type="button" onClick={() => onRemove(type, item.id)}
                            className="btn-icon text-red-600 hover:text-red-800 p-2 rounded-full transition-transform duration-200"
                            aria-label="Eliminar">
                        <Minus size={24} />
                    </button>
                )}
            </div>
        );

        const DataEntryScreen = ({ promoterName, promoterId, initialState, initialZone, newItem, setNewItem, error, setError, successMessage, setSuccessMessage, loading, setLoading }) => {
            const [presentationsCompetidor, setPresentationsCompetidor] = useState([]);
            const [presentationsMy, setPresentationsMy] = useState([]);
            const [estados, setEstados] = useState([]);
            const [zonas, setZonas] = useState([]);
            const [filteredZonas, setFilteredZonas] = useState([]);
            const [dataLoading, setDataLoading] = useState(true);

            useEffect(() => {
                const fetchData = async () => {
                    setDataLoading(true);
                    try {
                        const { data: compData } = await supabase.from('web_competidor').select('presentation').order('presentation');
                        const { data: myData } = await supabase.from('web_myproductos').select('presentation').order('presentation');
                        const { data: estadosData } = await supabase.from('web_estados').select('id, nombre').order('nombre');
                        const { data: zonasData } = await supabase.from('web_zonas').select('id, nombre, estado_id').order('nombre');

                        setPresentationsCompetidor(compData?.map(p => p.presentation) || []);
                        setPresentationsMy(myData?.map(p => p.presentation) || []);
                        setEstados(estadosData || []);
                        setZonas(zonasData || []);

                        if (initialState) setNewItem(prev => ({ ...prev, state: initialState }));
                        if (initialZone) setNewItem(prev => ({ ...prev, zone: initialZone }));
                    } catch (e) {
                        setError(`Error al cargar datos: ${e.message}`);
                    } finally {
                        setDataLoading(false);
                    }
                };
                fetchData();
            }, [initialState, initialZone]);

            useEffect(() => {
                if (newItem.state) {
                    const estadoId = estados.find(e => e.nombre === newItem.state)?.id;
                    const filtered = zonas.filter(z => z.estado_id === estadoId).map(z => z.nombre.replace('Zona ', ''));
                    setFilteredZonas(filtered);
                    if (newItem.zone && !filtered.includes(newItem.zone)) {
                        setNewItem(prev => ({ ...prev, zone: '' }));
                    }
                } else {
                    setFilteredZonas([]);
                }
            }, [newItem.state, estados, zonas]);

            const handleInputChange = (e, type, id, field) => {
                const { value } = e.target;
                setNewItem(prev => ({
                    ...prev,
                    [type]: prev[type].map(item => item.id === id ? { ...item, [field]: value } : item)
                }));
            };

            const handleAddClick = (type) => {
                setNewItem(prev => ({
                    ...prev,
                    [type]: [...prev[type], { id: crypto.randomUUID(), presentation: '', price: '', currency: '', stock_shelf: '', stock_warehouse: '' }]
                }));
            };

            const handleRemoveClick = (type, id) => {
                setNewItem(prev => ({
                    ...prev,
                    [type]: prev[type].filter(item => item.id !== id)
                }));
            };

            const handleSaveData = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                setSuccessMessage(null);

                try {
                    if (!newItem.state || !newItem.zone || !newItem.trade) {
                        setError("Completa Estado, Zona y Comercio.");
                        setLoading(false);
                        return;
                    }

                    const validCompetitorItems = newItem.competitoritems.filter(item => item.presentation && item.price && item.currency);
                    const validMyItems = newItem.myitems.filter(item => item.presentation && item.price && item.currency);

                    if (validCompetitorItems.length === 0 && validMyItems.length === 0) {
                        setError("Agrega al menos un √≠tem completo.");
                        setLoading(false);
                        return;
                    }

                    const visitData = {
                        promoter_id: promoterId,
                        promoter_name: promoterName,
                        state: newItem.state,
                        zone: newItem.zone,
                        trade: newItem.trade,
                        competitoritems: validCompetitorItems.map(item => ({
                            presentation: item.presentation,
                            price: parseFloat(item.price),
                            currency: item.currency
                        })),
                        myitems: validMyItems.map(item => ({
                            presentation: item.presentation,
                            price: parseFloat(item.price),
                            currency: item.currency,
                            stock_shelf: item.stock_shelf,
                            stock_warehouse: item.stock_warehouse
                        }))
                    };

                    const { error } = await supabase.from('web_precios').insert([visitData]);
                    if (error) throw error;

                    setNewItem({
                        state: initialState || '',
                        zone: initialZone || '',
                        trade: '',
                        competitoritems: [{ id: crypto.randomUUID(), presentation: '', price: '', currency: '' }],
                        myitems: [{ id: crypto.randomUUID(), presentation: '', price: '', currency: '', stock_shelf: '', stock_warehouse: '' }],
                    });
                    setSuccessMessage("¬°Datos guardados con √©xito!");
                } catch (e) {
                    setError(`Error al guardar: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-b from-indigo-100 to-gray-100 p-2 sm:p-4 flex flex-col items-center">
                    <div className="container w-full max-w-md bg-white card p-4 sm:p-6">
                        <h1 className="text-xl sm:text-2xl font-extrabold text-center text-indigo-700 mb-4">Ingreso de Precios</h1>
                        <p className="text-center text-gray-600 mb-4 text-sm">
                            Bienvenido, <span className="font-semibold text-indigo-600">{promoterName}</span>
                        </p>

                        {error && (
                            <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-3 mb-4 rounded-lg text-sm">
                                {error}
                            </div>
                        )}
                        {successMessage && (
                            <div className="bg-green-100 border-l-4 border-green-500 text-green-700 p-3 mb-4 rounded-lg text-sm">
                                {successMessage}
                            </div>
                        )}

                        {dataLoading && <div className="text-center text-gray-600 text-sm">Cargando...</div>}

                        <form onSubmit={handleSaveData} className="flex flex-col gap-4">
                            <div className="flex flex-col gap-2">
                                <label className="block">
                                    <span className="text-gray-700 font-semibold text-sm">Estado</span>
                                    <select value={newItem.state} onChange={(e) => setNewItem(prev => ({ ...prev, state: e.target.value }))}
                                            className="w-full p-3 border border-gray-300 rounded-xl input-focus" required disabled={!!initialState}>
                                        <option value="">-- Estado --</option>
                                        {estados.map(e => <option key={e.id} value={e.nombre}>{e.nombre}</option>)}
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700 font-semibold text-sm">Zona</span>
                                    <select value={newItem.zone} onChange={(e) => setNewItem(prev => ({ ...prev, zone: e.target.value }))}
                                            className="w-full p-3 border border-gray-300 rounded-xl input-focus" required disabled={!!initialZone}>
                                        <option value="">-- Zona --</option>
                                        {filteredZonas.map(z => <option key={z} value={z}>{z}</option>)}
                                    </select>
                                </label>
                                <label className="block">
                                    <span className="text-gray-700 font-semibold text-sm">Comercio</span>
                                    <input type="text" placeholder="Nombre del comercio" value={newItem.trade}
                                           onChange={(e) => setNewItem(prev => ({ ...prev, trade: e.target.value }))}
                                           className="w-full p-3 border border-gray-300 rounded-xl input-focus" required />
                                </label>
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-gray-700 font-bold text-sm">Precios Competencia</span>
                                    <button type="button" onClick={() => handleAddClick('competitoritems')}
                                            className="btn-icon bg-indigo-100 text-indigo-600 p-2 rounded-full hover:bg-indigo-200">
                                        <Plus size={24} />
                                    </button>
                                </div>
                                {newItem.competitoritems.map(item => (
                                    <ItemRow key={item.id} item={item} type="competitoritems" onChange={handleInputChange}
                                             onRemove={handleRemoveClick} presentations={presentationsCompetidor}
                                             currencies={['BS', '$', 'Pesos']} canRemove={newItem.competitoritems.length > 1} />
                                ))}
                            </div>

                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-gray-700 font-bold text-sm">Nuestros Precios</span>
                                    <button type="button" onClick={() => handleAddClick('myitems')}
                                            className="btn-icon bg-indigo-100 text-indigo-600 p-2 rounded-full hover:bg-indigo-200">
                                        <Plus size={24} />
                                    </button>
                                </div>
                                {newItem.myitems.map(item => (
                                    <ItemRow key={item.id} item={item} type="myitems" onChange={handleInputChange}
                                             onRemove={handleRemoveClick} presentations={presentationsMy}
                                             currencies={['BS', '$', 'Pesos']} canRemove={newItem.myitems.length > 1} />
                                ))}
                            </div>

                            <button type="submit" disabled={loading || dataLoading}
                                    className="w-full btn-primary text-white font-semibold py-3 rounded-xl flex items-center justify-center gap-2">
                                <Save size={24} />
                                {loading ? 'Guardando...' : 'Guardar Datos'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [promoterId, setPromoterId] = useState('');
            const [promoterName, setPromoterName] = useState('');
            const [initialState, setInitialState] = useState('');
            const [initialZone, setInitialZone] = useState('');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [successMessage, setSuccessMessage] = useState(null);
            const [newItem, setNewItem] = useState({
                state: '',
                zone: '',
                trade: '',
                competitoritems: [{ id: crypto.randomUUID(), presentation: '', price: '', currency: '' }],
                myitems: [{ id: crypto.randomUUID(), presentation: '', price: '', currency: '', stock_shelf: '', stock_warehouse: '' }],
            });

            // Registrar el Service Worker al cargar la p√°gina
            useEffect(() => {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        navigator.serviceWorker.register('/service-worker.js')
                            .then(registration => {
                                console.log('Service Worker registrado con √©xito:', registration);
                            })
                            .catch(error => {
                                console.error('Fallo el registro del Service Worker:', error);
                            });
                    });
                }
            }, []);

            const handleLogin = (id, name, estadoNombre, zonaNombre) => {
                setPromoterId(id);
                setPromoterName(name);
                setInitialState(estadoNombre);
                setInitialZone(zonaNombre);
                setNewItem(prev => ({ ...prev, state: estadoNombre, zone: zonaNombre }));
                setIsLoggedIn(true);
            };

            return (
                <ErrorBoundary>
                    <div className="font-sans antialiased">
                        {!isLoggedIn ? (
                            <LoginScreen onLogin={handleLogin} />
                        ) : (
                            <DataEntryScreen
                                promoterName={promoterName}
                                promoterId={promoterId}
                                initialState={initialState}
                                initialZone={initialZone}
                                newItem={newItem}
                                setNewItem={setNewItem}
                                error={error}
                                setError={setError}
                                successMessage={successMessage}
                                setSuccessMessage={setSuccessMessage}
                                loading={loading}
                                setLoading={setLoading}
                            />
                        )}
                    </div>
                </ErrorBoundary>
            );
        };

        // Renderizar
        try {
            const container = document.getElementById('root');
            if (container) {
                const root = createRoot(container);
                root.render(<App />);
            }
        } catch (e) {
            console.error('Error al renderizar:', e);
        }
    </script>
</body>
</html>
